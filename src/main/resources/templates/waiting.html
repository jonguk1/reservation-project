<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>대기실 - 잠시만 기다려주세요</title>
    <style>
        .waiting-box { text-align: center; margin-top: 100px; font-family: sans-serif; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #rank-display { font-size: 3rem; color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="waiting-box">
        <h1>예약 대기 중입니다</h1>
        <div class="spinner"></div>
        <p>새로고침을 하지 마세요. 순서가 밀려날 수 있습니다.</p>
        <div id="rank-display">계산 중...</div>
        <p>내 앞 대기 인원: <span id="count">--</span>명</p>
    </div>

    <script th:inline="javascript">
        const goodsId = [[${goodsId}]];
        
        function checkRank() {
            fetch(`/api/waiting/join?goodsId=${goodsId}`, { method: 'POST' })
            .then(response => response.json())
            .then(res => {
                // 서버 응답이 객체일 경우(예: {data: 5})와 숫자일 경우 모두 대응
                const rank = (res.data !== undefined) ? res.data : res;

                console.log("현재 랭크:", rank); // 크롬 F12 콘솔에서 확인 가능

                if (rank === 0) {
                    alert("내 차례입니다! 예약 페이지로 이동합니다.");
                    location.href = "/reserve?goodsId=" + goodsId;
                    return;
                }

                // 정상적인 숫자일 때만 화면 표시
                if (typeof rank === 'number') {
                    document.getElementById("count").innerText = rank - 1; // 내 앞 대기 인원
                    document.getElementById("rank-display").innerText = rank + "번째";
                }
            });
        }

        // 3초마다 순번 체크 실행
        setInterval(checkRank, 3000);
     	// 처음 진입 시 바로 한 번 실행
        checkRank();
    </script>
</body>
</html>